using UnityEditor;
using UnityEditor.SceneManagement;
using UnityEngine;

namespace Framework.Editor
{
    /// <summary>
    /// UIKit 热盒 - 模仿 Maya Hotbox 的快捷工具面板
    /// 按住 Space 键在鼠标位置显示，松开隐藏
    /// </summary>
    [InitializeOnLoad]
    public static class UIKitHotbox
    {
        private static bool _isShowing;
        private static Vector2 _hotboxCenter;
        private static Rect _hotboxRect;
        private static Texture2D _bgTexture;

        // 热盒配置
        private const float BoxWidth = 320f;
        private const float BoxHeight = 260f;
        private const KeyCode HotKey = KeyCode.Space;

        // 颜色配置
        private static readonly Color BgColor = new Color(0.12f, 0.12f, 0.12f, 0.96f);
        private static readonly Color BorderColor = new Color(0.3f, 0.6f, 0.9f, 0.8f);
        private static readonly Color TitleColor = new Color(0.4f, 0.75f, 1f);
        private static readonly Color SectionColor = new Color(0.7f, 0.7f, 0.7f);

        static UIKitHotbox()
        {
            SceneView.duringSceneGui -= OnSceneGUI;
            SceneView.duringSceneGui += OnSceneGUI;
        }

        private static void OnSceneGUI(SceneView sceneView)
        {
            Event e = Event.current;

            // 检测热键按下
            if (e.type == EventType.KeyDown && e.keyCode == HotKey && !_isShowing)
            {
                _isShowing = true;
                _hotboxCenter = e.mousePosition;

                // 确保热盒不会超出 Scene 视图边界
                float halfW = BoxWidth / 2;
                float halfH = BoxHeight / 2;
                float x = Mathf.Clamp(_hotboxCenter.x, halfW + 10, sceneView.position.width - halfW - 10);
                float y = Mathf.Clamp(_hotboxCenter.y, halfH + 10, sceneView.position.height - halfH - 10);

                _hotboxRect = new Rect(x - halfW, y - halfH, BoxWidth, BoxHeight);
                e.Use();
                sceneView.Repaint();
            }

            // 检测热键松开
            if (e.type == EventType.KeyUp && e.keyCode == HotKey && _isShowing)
            {
                _isShowing = false;
                e.Use();
                sceneView.Repaint();
            }

            // 绘制热盒
            if (_isShowing)
            {
                Handles.BeginGUI();
                DrawHotbox();
                Handles.EndGUI();

                // 持续重绘以保持响应
                sceneView.Repaint();
            }
        }

        private static void DrawHotbox()
        {
            // 绘制背景
            DrawBackground();

            GUILayout.BeginArea(_hotboxRect);

            GUILayout.BeginVertical();
            {
                GUILayout.Space(12);

                // ========== 标题 ==========
                DrawCenteredLabel("UIKit Hotbox", TitleColor, 14, FontStyle.Bold);

                GUILayout.Space(8);

                // ========== 上方区域：Panel 工具 ==========
                DrawSectionHeader("Panel");
                GUILayout.BeginHorizontal();
                {
                    GUILayout.FlexibleSpace();

                    if (DrawHotboxButton("创建UI模板", 85))
                    {
                        _isShowing = false;
                        UIPanelNameInputWindow.ShowWindow((name, template) =>
                        {
                            UIEditor.ExecuteCreateUITemplate(name, template);
                        });
                    }

                    GUILayout.Space(4);

                    if (DrawHotboxButton("绑定节点", 70))
                    {
                        _isShowing = false;
                        UIEditor.AddBindComponent();
                    }

                    GUILayout.Space(4);

                    if (DrawHotboxButton("导出Panel", 75))
                    {
                        _isShowing = false;
                        UIEditor.StartExportProcess();
                    }

                    GUILayout.FlexibleSpace();
                }
                GUILayout.EndHorizontal();
                
                GUILayout.Space(3);
                
                // 定位按钮（单独一行）
                GUILayout.BeginHorizontal();
                {
                    GUILayout.FlexibleSpace();
                    
                    if (DrawHotboxButton("定位 ExportRoot", 130))
                    {
                        _isShowing = false;
                        LocateExportRoot();
                    }
                    
                    GUILayout.FlexibleSpace();
                }
                GUILayout.EndHorizontal();

                GUILayout.Space(10);

                // ========== 左右分区 ==========
                GUILayout.BeginHorizontal();
                {
                    GUILayout.Space(15);

                    // 左侧：ListView
                    GUILayout.BeginVertical(GUILayout.Width(135));
                    {
                        DrawSectionHeader("ListView");

                        if (DrawHotboxButton("生成 ViewsHolder", 130))
                        {
                            _isShowing = false;
                            ListViewEditor.GenerateViewsHolder();
                        }

                        GUILayout.Space(3);

                        if (DrawHotboxButton("生成 Adapter", 130))
                        {
                            _isShowing = false;
                            ListViewEditor.GenerateAdapter();
                        }

                        GUILayout.Space(3);

                        if (DrawHotboxButton("清理废弃 VH", 130))
                        {
                            _isShowing = false;
                            ListViewEditor.CleanupOrphanedViewsHolders();
                        }
                    }
                    GUILayout.EndVertical();

                    GUILayout.FlexibleSpace();

                    // 右侧：其他工具
                    GUILayout.BeginVertical(GUILayout.Width(135));
                    {
                        DrawSectionHeader("其他");

                        if (DrawHotboxButton("清理废弃资源", 130))
                        {
                            _isShowing = false;
                            if (EditorUtility.DisplayDialog("提示",
                                "将删除没有对应场景文件的 Generated 脚本和 Prefab，是否继续？",
                                "确定", "取消"))
                            {
                                UIEditor.CleanupOrphanedAssets();
                                ListViewEditor.CleanupOrphanedViewsHolders();
                            }
                        }

                        GUILayout.Space(3);

                        if (DrawHotboxButton("刷新资源", 130))
                        {
                            _isShowing = false;
                            AssetDatabase.Refresh();
                        }

                        GUILayout.Space(3);

                        if (DrawHotboxButton("返回 GameBoot", 130))
                        {
                            _isShowing = false;
                            ReturnToGameBoot();
                        }
                    }
                    GUILayout.EndVertical();

                    GUILayout.Space(15);
                }
                GUILayout.EndHorizontal();

                GUILayout.FlexibleSpace();

                // 底部提示
                DrawCenteredLabel("松开 Space 关闭", new Color(0.5f, 0.5f, 0.5f), 10, FontStyle.Italic);
                GUILayout.Space(8);
            }
            GUILayout.EndVertical();

            GUILayout.EndArea();
        }

        #region 绘制辅助方法

        private static void DrawBackground()
        {
            // 创建背景纹理（缓存）
            if (_bgTexture == null)
            {
                _bgTexture = new Texture2D(1, 1);
                _bgTexture.SetPixel(0, 0, BgColor);
                _bgTexture.Apply();
            }

            // 绘制主背景
            GUI.DrawTexture(_hotboxRect, _bgTexture);

            // 绘制边框
            DrawBorder(_hotboxRect, BorderColor, 2);
        }

        private static void DrawBorder(Rect rect, Color color, int thickness)
        {
            // 上边
            EditorGUI.DrawRect(new Rect(rect.x, rect.y, rect.width, thickness), color);
            // 下边
            EditorGUI.DrawRect(new Rect(rect.x, rect.yMax - thickness, rect.width, thickness), color);
            // 左边
            EditorGUI.DrawRect(new Rect(rect.x, rect.y, thickness, rect.height), color);
            // 右边
            EditorGUI.DrawRect(new Rect(rect.xMax - thickness, rect.y, thickness, rect.height), color);
        }

        private static void DrawCenteredLabel(string text, Color color, int fontSize, FontStyle fontStyle)
        {
            var style = new GUIStyle(EditorStyles.label)
            {
                alignment = TextAnchor.MiddleCenter,
                fontSize = fontSize,
                fontStyle = fontStyle,
                normal = { textColor = color }
            };

            GUILayout.Label(text, style);
        }

        private static void DrawSectionHeader(string text)
        {
            var style = new GUIStyle(EditorStyles.miniLabel)
            {
                alignment = TextAnchor.MiddleCenter,
                normal = { textColor = SectionColor },
                fontStyle = FontStyle.Bold
            };

            GUILayout.Label(text, style);
            GUILayout.Space(2);
        }

        private static bool DrawHotboxButton(string text, float width)
        {
            var style = new GUIStyle(GUI.skin.button)
            {
                fontSize = 11,
                padding = new RectOffset(4, 4, 4, 4)
            };

            return GUILayout.Button(text, style, GUILayout.Width(width), GUILayout.Height(24));
        }

        #endregion

        #region 功能方法

        /// <summary>
        /// 定位到当前场景的 ExportRoot 节点
        /// </summary>
        private static void LocateExportRoot()
        {
            // 1. 查找 UIPanelDescription
            var desc = Object.FindFirstObjectByType<UIPanelDescription>();
            if (desc == null)
            {
                EditorUtility.DisplayDialog("提示", "当前场景未找到 UIPanelDescription 组件", "确定");
                return;
            }
            
            // 2. 查找 ExportRoot
            GameObject exportRoot = GameObject.Find(UIEditorConstants.ExportRoot);
            if (exportRoot == null)
            {
                EditorUtility.DisplayDialog("提示", $"当前场景未找到 {UIEditorConstants.ExportRoot} 节点", "确定");
                return;
            }
            
            // 3. 选中并展开到 ExportRoot
            Selection.activeGameObject = exportRoot;
            
            // 在 Hierarchy 中展开并定位
            EditorGUIUtility.PingObject(exportRoot);
            
            // 展开父级节点
            ExpandHierarchyToObject(exportRoot);
            
            UniLogger.Log($"<color=green>已定位到: {desc.PackageName}/{EditorSceneManager.GetActiveScene().name}</color>");
        }

        /// <summary>
        /// 在 Hierarchy 中展开到指定对象
        /// </summary>
        private static void ExpandHierarchyToObject(GameObject target)
        {
            // 使用反射调用 Hierarchy 窗口的展开方法
            var hierarchyType = typeof(EditorWindow).Assembly.GetType("UnityEditor.SceneHierarchyWindow");
            if (hierarchyType == null) return;
            
            var window = EditorWindow.GetWindow(hierarchyType);
            if (window == null) return;
            
            // 获取 sceneHierarchy 属性
            var sceneHierarchy = hierarchyType.GetProperty("sceneHierarchy", 
                System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic)?.GetValue(window);
            
            if (sceneHierarchy != null)
            {
                var setExpandedMethod = sceneHierarchy.GetType().GetMethod("SetExpanded", 
                    System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.Public);
                
                if (setExpandedMethod != null)
                {
                    // 展开所有父级
                    Transform current = target.transform;
                    while (current != null)
                    {
                        setExpandedMethod.Invoke(sceneHierarchy, new object[] { current.gameObject.GetInstanceID(), true });
                        current = current.parent;
                    }
                }
            }
            
            window.Repaint();
        }

        private static void ReturnToGameBoot()
        {
            const string gameBootPath = "Assets/Scenes/GameBoot.unity";

            if (EditorSceneManager.GetActiveScene().isDirty)
            {
                int option = EditorUtility.DisplayDialogComplex(
                    "场景已修改",
                    "当前场景有未保存的修改，是否保存？",
                    "保存并返回", "不保存返回", "取消");

                switch (option)
                {
                    case 0:
                        EditorSceneManager.SaveOpenScenes();
                        break;
                    case 1:
                        break;
                    case 2:
                        return;
                }
            }

            EditorSceneManager.OpenScene(gameBootPath);
        }

        #endregion
    }
}
