using Cysharp.Threading.Tasks;
using UnityEngine;
using UnityEngine.UI;

namespace Framework
{
    public abstract class UIPopupPanelBase<T> : UIPanelBase<T> where T : UIPanelBase<T>, new()
    {
        public override UILayerEnum DefaultLayer => UILayerEnum.Popup;

        protected virtual bool EnableMask => true; // 是否允许点击遮罩关闭弹窗
        protected virtual Color MaskColor => new Color(0, 0, 0, 0.7f);

        private GameObject _maskObject;

        public override void Show()
        {
            CreateMask();
            base.Show();
        }

        private void CreateMask()
        {
            if (_maskObject != null) return;

            // 创建遮罩作为面板的第一个子节点
            _maskObject = new GameObject("PopupMask", typeof(RectTransform), typeof(Image));
            _maskObject.transform.SetParent(transform, false);
            _maskObject.transform.SetAsFirstSibling(); // 放在最下面

            // 铺满父节点
            RectTransform maskRect = _maskObject.GetComponent<RectTransform>();
            maskRect.anchorMin = Vector2.zero;
            maskRect.anchorMax = Vector2.one;
            maskRect.offsetMin = Vector2.zero;
            maskRect.offsetMax = Vector2.zero;

            Image maskImage = _maskObject.GetComponent<Image>();
            maskImage.color = MaskColor;
            maskImage.raycastTarget = true;

            Button maskButton = _maskObject.AddComponent<Button>();
            maskButton.transition = Selectable.Transition.None;
            maskButton.onClick.AddListener(OnMaskClick);
        }

        protected virtual void OnMaskClick()
        {
            if (!EnableMask) return;
            UIKit.Instance.CloseAsync<T>().Forget();
        }
    }
}