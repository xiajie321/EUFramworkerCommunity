using System.IO;
using UnityEditor;
using UnityEditor.U2D;
using UnityEngine;
using UnityEngine.U2D;

namespace Framework.Editor
{
    /// <summary>
    /// UI 资源编辑器工具：负责图片类型自动转换、图集一键生成等
    /// </summary>
    [InitializeOnLoad]
    public static class UISpriteEditor
    {
        static UISpriteEditor()
        {
            UniLogger.Log("<color=cyan>[UISpriteEditor] 脚本已加载并初始化成功。</color>");
        }

        // 测试菜单
        [MenuItem("Framework/UIKit/Debug/Test Script Life", false, 0)]
        public static void TestLife()
        {
            UniLogger.Log("<color=green>[UISpriteEditor] 脚本运行正常！</color>");
            EditorUtility.DisplayDialog("提示", "UISpriteEditor 脚本运行正常！", "确定");
        }

        [MenuItem("Framework/UIKit/Sprite/一键生成图集 &g", false, 1)]
        public static void GenerateAtlasFromFolder()
        {
            UniLogger.Log("[UISpriteEditor] ---> 开始执行图集生成流程 <---");

            // 1. 尝试获取选中的文件夹路径
            string folderPath = GetSelectedFolderPath();
            
            if (string.IsNullOrEmpty(folderPath))
            {
                UniLogger.LogWarning("[UISpriteEditor] 失败：未识别到选中的文件夹。");
                EditorUtility.DisplayDialog("提示", "请先在 Project 窗口选中一个【存放图片的文件夹】！", "确定");
                return;
            }

            UniLogger.Log($"[UISpriteEditor] 识别到文件夹路径: {folderPath}");

            // 2. 自动识别保存目录 (首包还是远程)
            string saveDir = UIEditorConstants.UIAtlasSavePath; // 默认远程
            if (folderPath.Contains("/Builtin/"))
            {
                saveDir = UIEditorConstants.UIAtlasBuiltinSavePath;
                UniLogger.Log("[UISpriteEditor] 识别为【首包(Builtin)】资源文件夹。");
            }
            else
            {
                UniLogger.Log("[UISpriteEditor] 识别为【远程(Remote)】资源文件夹。");
            }

            string folderName = Path.GetFileName(folderPath);

            try 
            {
                // 3. 自动化处理：将文件夹内的图片全部转为 Sprite 类型
                ProcessTexturesInFolder(folderPath);

                // 4. 确定图集保存全路径
                UIEditorConstants.EnsureDirectory(saveDir);
                string atlasPath = $"{saveDir}/{folderName}.spriteatlas";
                UniLogger.Log($"[UISpriteEditor] 图集保存路径: {atlasPath}");

                // 5. 创建或获取图集对象
                SpriteAtlas atlas = AssetDatabase.LoadAssetAtPath<SpriteAtlas>(atlasPath);
                bool isNew = false;
                if (atlas == null)
                {
                    atlas = new SpriteAtlas();
                    isNew = true;
                    UniLogger.Log("[UISpriteEditor] 创建新图集。");
                }
                else
                {
                    UniLogger.Log("[UISpriteEditor] 更新现有图集。");
                }

                // 6. 设置图集参数
                SetAtlasSettings(atlas);

                // 7. 关联文件夹
                UnityEngine.Object folderObj = AssetDatabase.LoadAssetAtPath<UnityEngine.Object>(folderPath);
                if (folderObj == null)
                {
                    UniLogger.LogError("[UISpriteEditor] 无法加载文件夹对象。");
                    return;
                }
                
                SpriteAtlasExtensions.Add(atlas, new UnityEngine.Object[] { folderObj });
                UniLogger.Log("[UISpriteEditor] 已关联目标文件夹。");

                // 8. 保存资源
                if (isNew)
                {
                    AssetDatabase.CreateAsset(atlas, atlasPath);
                }
                
                AssetDatabase.SaveAssets();
                AssetDatabase.Refresh();

                UniLogger.Log($"<color=green>[UISpriteEditor] 处理成功: {atlasPath}</color>");
                
                Selection.activeObject = atlas;
                EditorUtility.DisplayDialog("成功", $"图集 [{folderName}] 处理完成！\n保存位置: {saveDir}\n请在 Inspector 面板确认并点击 'Pack Preview'。", "确定");
            }
            catch (System.Exception e)
            {
                UniLogger.LogError($"[UISpriteEditor] 运行异常: {e.Message}\n{e.StackTrace}");
            }
        }

        /// <summary>
        /// 更加健壮的文件夹路径获取逻辑
        /// </summary>
        private static string GetSelectedFolderPath()
        {
            var objects = Selection.GetFiltered<UnityEngine.Object>(SelectionMode.Assets);
            foreach (var obj in objects)
            {
                string path = AssetDatabase.GetAssetPath(obj);
                if (AssetDatabase.IsValidFolder(path)) return path;
                
                if (File.Exists(path))
                {
                    string dir = Path.GetDirectoryName(path);
                    if (AssetDatabase.IsValidFolder(dir)) return dir;
                }
            }
            return null;
        }

        private static void ProcessTexturesInFolder(string folderPath)
        {
            string[] guids = AssetDatabase.FindAssets("t:Texture", new[] { folderPath });
            int count = 0;
            foreach (var guid in guids)
            {
                string path = AssetDatabase.GUIDToAssetPath(guid);
                TextureImporter importer = AssetImporter.GetAtPath(path) as TextureImporter;
                if (importer != null && (importer.textureType != TextureImporterType.Sprite || importer.mipmapEnabled))
                {
                    importer.textureType = TextureImporterType.Sprite;
                    importer.mipmapEnabled = false;
                    importer.alphaIsTransparency = true;
                    importer.wrapMode = TextureWrapMode.Clamp;
                    importer.SaveAndReimport();
                    count++;
                }
            }
            if (count > 0) UniLogger.Log($"[UISpriteEditor] 自动转换了 {count} 张贴图为 Sprite 类型。");
        }

        private static void SetAtlasSettings(SpriteAtlas atlas)
        {
            SpriteAtlasPackingSettings packingSettings = new SpriteAtlasPackingSettings()
            {
                blockOffset = 1,
                enableRotation = false,
                enableTightPacking = false,
                padding = 4
            };
            atlas.SetPackingSettings(packingSettings);

            SpriteAtlasTextureSettings textureSettings = new SpriteAtlasTextureSettings()
            {
                readable = false,
                generateMipMaps = false,
                sRGB = true,
                filterMode = FilterMode.Bilinear
            };
            atlas.SetTextureSettings(textureSettings);
        }
    }
}
